<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Widget Connection Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        #results { margin-top: 20px; }
        .log-entry { margin: 5px 0; padding: 5px; border-left: 3px solid #ccc; }
    </style>
</head>
<body>
    <h1>üß™ Chat Widget Connection Test</h1>
    
    <div class="test-section info">
        <h3>Environment Check</h3>
        <div id="env-check"></div>
    </div>

    <div class="test-section">
        <h3>Connection Tests</h3>
        <button onclick="testWebhookConnection()">Test Webhook Connection</button>
        <button onclick="testCORS()">Test CORS</button>
        <button onclick="testEnvironmentVariable()">Test Environment Variable</button>
        <button onclick="simulateChatWidget()">Simulate Chat Widget Call</button>
    </div>

    <div class="test-section">
        <h3>Results</h3>
        <div id="results"></div>
    </div>

    <script>
        const WEBHOOK_URL = 'https://cwai97.app.n8n.cloud/webhook/serenity-webhook-v2';
        const RESULTS_DIV = document.getElementById('results');
        const ENV_DIV = document.getElementById('env-check');

        // Environment check
        function checkEnvironment() {
            const envCheck = {
                'VITE_N8N_WEBHOOK_BASE': typeof window !== 'undefined' ? 'NOT ACCESSIBLE (Node.js only)' : 'Check console',
                'window.location': window.location.href,
                'User Agent': navigator.userAgent,
                'CORS Support': 'fetch' in window ? 'YES' : 'NO'
            };

            ENV_DIV.innerHTML = Object.entries(envCheck).map(([key, value]) => 
                `<div><strong>${key}:</strong> ${value}</div>`
            ).join('');
        }

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'success' ? 'green' : type === 'error' ? 'red' : 'blue';
            RESULTS_DIV.innerHTML += `<div class="log-entry" style="border-left-color: ${color}; color: ${color};">[${timestamp}] ${message}</div>`;
        }

        async function testWebhookConnection() {
            log('üß™ Testing webhook connection...', 'info');
            
            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'test',
                        message: 'Browser connection test'
                    })
                });

                if (response.ok) {
                    log(`‚úÖ Webhook connection successful! Status: ${response.status}`, 'success');
                } else {
                    log(`‚ùå Webhook connection failed! Status: ${response.status}`, 'error');
                }
                
                const responseText = await response.text();
                log(`üìß Response: ${responseText}`);
                
            } catch (error) {
                log(`‚ùå Connection error: ${error.message}`, 'error');
                if (error.message.includes('CORS')) {
                    log('üîç CORS issue detected! The n8n webhook needs CORS configuration.', 'error');
                }
                if (error.message.includes('Failed to fetch')) {
                    log('üîç Network issue or CORS blockage. Check browser console for details.', 'error');
                }
            }
        }

        async function testCORS() {
            log('üß™ Testing CORS preflight...', 'info');
            
            try {
                // Test with a more complex request that triggers CORS
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Custom-Header': 'test'
                    },
                    body: JSON.stringify({
                        action: 'send_message',
                        channel: 'whatsapp',
                        message: 'CORS test message'
                    })
                });

                log(`‚úÖ CORS test completed. Status: ${response.status}`, 'success');
                
                // Check response headers for CORS
                const corsHeaders = response.headers.get('Access-Control-Allow-Origin');
                if (corsHeaders) {
                    log(`‚úÖ CORS headers present: ${corsHeaders}`, 'success');
                } else {
                    log('‚ö†Ô∏è No CORS headers found in response', 'info');
                }
                
            } catch (error) {
                log(`‚ùå CORS test failed: ${error.message}`, 'error');
            }
        }

        function testEnvironmentVariable() {
            log('üß™ Testing environment variable access...', 'info');
            
            // In browser, we can't access import.meta.env directly
            // But we can check if the chat widget is properly configured
            const expectedWebhookBase = 'https://cwai97.app.n8n.cloud/webhook';
            
            log(`Expected webhook base: ${expectedWebhookBase}`);
            log(`Current origin: ${window.location.origin}`);
            
            // Check if we're in development mode
            if (window.location.port === '5175' || window.location.port === '5174') {
                log('‚úÖ Development environment detected', 'success');
            } else {
                log('‚ö†Ô∏è Production environment detected', 'info');
            }
        }

        async function simulateChatWidget() {
            log('üß™ Simulating chat widget appointment booking...', 'info');
            
            const appointmentData = {
                // Primary fields for n8n workflow
                message: 'Appointment booking request from Browser Test',
                userId: 'test@example.com',
                channel: 'web',
                intent: 'appointment',

                // Patient contact (both formats for compatibility)
                patientName: 'Browser Test User',
                patientEmail: 'test@example.com',
                patientPhone: '+1234567890',
                patient_name: 'Browser Test User',
                patient_email: 'test@example.com',
                patient_phone: '+1234567890',

                // Appointment details (both formats)
                appointmentDate: '2024-12-21',
                appointmentTime: '10:00 AM',
                appointmentReason: 'Browser test appointment',
                appointmentType: 'consultation',
                appointment_date: '2024-12-21',
                appointment_time: '10:00 AM',
                appointment_reason: 'Browser test appointment',
                appointment_type: 'consultation',

                // Legacy fields for backward compatibility
                name: 'Browser Test User',
                email: 'test@example.com',
                phone: '+1234567890',
                date: '2024-12-21',
                time: '10:00 AM',
                reason: 'Browser test appointment',

                // Metadata
                source: 'groq_text_chat',
                action: 'book_appointment_with_confirmation',
                timestamp: new Date().toISOString(),
            };

            log('üì§ Sending appointment booking request...');
            log('üìã Payload preview: ' + JSON.stringify(appointmentData, null, 2).substring(0, 200) + '...');

            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(appointmentData)
                });

                if (response.ok) {
                    log(`‚úÖ Chat widget simulation successful! Status: ${response.status}`, 'success');
                    log('üìß Check your email for the appointment confirmation!');
                } else {
                    log(`‚ùå Chat widget simulation failed! Status: ${response.status}`, 'error');
                }

                const responseText = await response.text();
                log(`üìß Response: ${responseText}`);

            } catch (error) {
                log(`‚ùå Chat widget simulation error: ${error.message}`, 'error');
                
                // Provide specific troubleshooting based on error
                if (error.message.includes('CORS')) {
                    log('üîß SOLUTION: Configure n8n webhook to allow CORS from your domain', 'error');
                    log('üîß Add CORS headers to n8n webhook response', 'error');
                } else if (error.message.includes('Failed to fetch')) {
                    log('üîß SOLUTION: Check if n8n instance is running and accessible', 'error');
                    log('üîß Verify webhook URL is correct', 'error');
                }
            }
        }

        // Initialize
        checkEnvironment();
        log('üöÄ Chat Widget Connection Test initialized', 'success');
        log('Click the buttons above to run connection tests', 'info');
    </script>
</body>
</html>