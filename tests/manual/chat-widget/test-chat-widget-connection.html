<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Widget Connection Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        #log { background: #f5f5f5; padding: 10px; border-radius: 5px; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>Chat Widget Connection Test</h1>
    
    <div class="test-section">
        <h3>Environment Check</h3>
        <div id="env-check"></div>
    </div>
    
    <div class="test-section">
        <h3>Direct Webhook Test</h3>
        <button onclick="testDirectWebhook()">Test Direct Webhook Call</button>
        <div id="webhook-result"></div>
    </div>
    
    <div class="test-section">
        <h3>Chat Widget Test</h3>
        <button onclick="testChatWidget()">Test Chat Widget Integration</button>
        <div id="widget-result"></div>
    </div>
    
    <div class="test-section">
        <h3>Connection Log</h3>
        <div id="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div class="${type}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function checkEnvironment() {
            log('Checking environment variables...');
            
            // Check if we're in the right environment
            const envCheck = document.getElementById('env-check');
            
            // VITE_N8N_WEBHOOK_BASE is not accessible from browser, but we can check if the app is running
            const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            
            envCheck.innerHTML = `
                <div class="${isLocalhost ? 'success' : 'info'}">
                    Host: ${window.location.hostname}<br>
                    Port: ${window.location.port}<br>
                    Protocol: ${window.location.protocol}<br>
                    VITE_N8N_WEBHOOK_BASE: <span id="webhook-base">Checking...</span>
                </div>
            `;
            
            log(`Running on ${window.location.hostname}:${window.location.port}`, 'success');
        }

        async function testDirectWebhook() {
            const resultDiv = document.getElementById('webhook-result');
            resultDiv.innerHTML = '<div class="info">Testing direct webhook call...</div>';
            
            try {
                // This simulates what the chat widget does
                const payload = {
                    conversationId: 'test-conv-browser',
                    sessionId: 'test-conv-browser',
                    patientRef: 'patient-browser-test',
                    userId: 'patient-browser-test',
                    intent: 'appointment',
                    appointmentDate: '2024-12-21',
                    appointmentTime: '2:00 PM',
                    appointmentReason: 'Browser test appointment',
                    appointmentType: 'consultation',
                    patientEmail: 'test@browser.com',
                    patientPhone: '+1234567890',
                    patientName: 'Browser Test User',
                    message: 'Appointment booking request from browser test',
                    channel: 'webchat',
                    timestamp: new Date().toISOString()
                };

                log('Sending payload to webhook...');
                log('Payload: ' + JSON.stringify(payload, null, 2));

                const response = await fetch('https://cwai97.app.n8n.cloud/webhook/serenity-webhook-v2', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                log(`Response status: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.text();
                    resultDiv.innerHTML = `<div class="success">✅ Webhook call successful!<br>Status: ${response.status}<br>Response: ${data}</div>`;
                    log('Webhook test successful!', 'success');
                } else {
                    const errorText = await response.text();
                    resultDiv.innerHTML = `<div class="error">❌ Webhook call failed!<br>Status: ${response.status}<br>Error: ${errorText}</div>`;
                    log(`Webhook test failed: ${response.status} ${errorText}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ Network error: ${error.message}</div>`;
                log(`Network error: ${error.message}`, 'error');
                
                if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
                    log('This appears to be a CORS issue. The n8n webhook may need CORS configuration.', 'error');
                }
            }
        }

        async function testChatWidget() {
            const resultDiv = document.getElementById('widget-result');
            resultDiv.innerHTML = '<div class="info">Testing chat widget integration...</div>';
            
            try {
                // Check if the chat widget scripts are loaded
                log('Checking for chat widget functions...');
                
                // Simulate what the chat widget does
                const messages = [
                    { role: 'user', content: 'I want to book an appointment for tomorrow at 2pm' },
                    { role: 'assistant', content: 'I can help you book an appointment. What is your email address?' },
                    { role: 'user', content: 'My email is test@example.com and phone is 555-123-4567' }
                ];

                log('Simulating appointment booking flow...');
                log('Message history: ' + JSON.stringify(messages, null, 2));

                // Check if appointment intent is detected
                const hasAppointmentIntent = messages.some(m => 
                    m.content.toLowerCase().includes('appointment') ||
                    m.content.toLowerCase().includes('book') ||
                    m.content.toLowerCase().includes('schedule')
                );

                if (hasAppointmentIntent) {
                    log('✅ Appointment intent detected!', 'success');
                    
                    // Extract contact info
                    const emailPattern = /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/;
                    const phonePattern = /\b\d{3}[-.]?\d{3}[-.]?\d{4}\b|\+\d{1,3}\s?\d{3,4}\s?\d{3,4}\s?\d{3,4}\b/;
                    
                    const lastMessage = messages[messages.length - 1].content;
                    const emailMatch = lastMessage.match(emailPattern);
                    const phoneMatch = lastMessage.match(phonePattern);

                    if (emailMatch || phoneMatch) {
                        log('✅ Contact info found!', 'success');
                        log(`Email: ${emailMatch?.[0] || 'N/A'}`);
                        log(`Phone: ${phoneMatch?.[0] || 'N/A'}`);
                        
                        // This is where the chat widget would trigger the appointment booking
                        resultDiv.innerHTML = `<div class="success">✅ Chat widget integration working!<br>Appointment intent: Detected<br>Contact info: Found<br>Ready to trigger booking workflow</div>`;
                        
                        // Actually trigger the booking to test the full flow
                        await testDirectWebhook();
                    } else {
                        log('❌ No contact info found', 'error');
                        resultDiv.innerHTML = '<div class="error">❌ No contact info found in messages</div>';
                    }
                } else {
                    log('❌ No appointment intent detected', 'error');
                    resultDiv.innerHTML = '<div class="error">❌ No appointment intent detected in messages</div>';
                }

            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ Chat widget test failed: ${error.message}</div>`;
                log(`Chat widget test error: ${error.message}`, 'error');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkEnvironment();
            log('Chat widget connection test initialized');
        });
    </script>
</body>
</html>